<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<base href="{{ base }}" >
		<title>{{ title }}</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
		<link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
		<link rel="stylesheet" href="assets/css/bootstrap.min.css">
		<link rel="stylesheet" href="assets/css/bible.css">
		<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
		<script src="plugins/jquery/jquery.min.js"></script>
		<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script language="javascript">
			var data = {{ body|raw }};
		</script>
	</head>
	<body>
 <header>
      <!-- Fixed navbar -->
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="/bible">{{ title }}</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav mr-auto"></ul>
          <form class="form-inline mt-2 mt-md-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
          </form>
        </div>
      </nav>
    </header>

    <!-- Begin page content -->
    <main role="main" class="row" >
		<div class="col-md-3 sidebar">
		   <ul class="nav flex-column" id="apps">
				<li><h4>Installed Apps</h4></li>
           </ul>
		</div>
		<div class="col-md-9">
			<div class="d-flex align-items-center p-3 my-3 text-white-50 bg-purple rounded box-shadow">
                  <div class="lh-100">
                      <h6 class="mb-0 text-white lh-100 cf" id="app_name"></h6>
                      <small id="app_info" class="cf"></small>
                  </div>
            </div>

			<div class="my-3 p-3 bg-white rounded box-shadow" id="content">



			</div>
		</div>

    </main>

    <footer class="footer">
      <div class="container">
        <span class="text-muted">Auto generated by EVO Bible.</span>
      </div>
    </footer>

	</body>
</html>

<template name="menuitem">
	<li class="nav-item">
        <a class="nav-link" href="/bible?app=${name}&view=app">${name}</a>
        <span>${description}</span>
    </li>
</template>

<template name="app">
	 <h6 class="border-bottom border-gray pb-2 mb-0">Documented Information</h6>
     <div class="media text-muted pt-3">
      <div alt="32x32" class="mr-2 rounded bg-blue app-icon"><i class="fa fa-project-diagram"></i></div>
      <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
        <a href="/bible?app=${app}&view=api"><strong class="d-block text-gray-dark">APIs</strong></a>
        <span id="api_info"></span>
      </p>
    </div>
    <div class="media text-muted pt-3">
      <div alt="32x32" class="mr-2 rounded bg-blue app-icon"><i class="fa fa-database"></i> </div>
      <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
        <a href="/bible?app=${app}&view=model"><strong class="d-block text-gray-dark">Models</strong></a>
        <span id="model_info"></span>
      </p>
    </div>

    <div class="media text-muted pt-3">
      <div alt="32x32" class="mr-2 rounded bg-blue app-icon" ><i class="fa fa-shield-alt"></i> </div>
      <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
        <a href="/bible?app=${app}&view=permission"><strong class="d-block text-gray-dark">Permissions</strong></a>
        <span id="permission_info"></span>
      </p>
    </div>
    <div class="media text-muted pt-3">
      <div alt="32x32" class="mr-2 rounded bg-blue app-icon" ><i class="fa fa-bars"></i> </div>
      <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
        <a href="/bible?app=${app}&view=menu"><strong class="d-block text-gray-dark">Menus</strong></a>
        <span id="menu_info"></span>
      </p>
    </div>
</template>
<template name="api">
	<div class="text-muted pt-3  ${selected}">
		<p class="pb-3 mb-0 small lh-125 border-bottom border-gray">
		 <strong class="d-block text-gray-dark">${name}</strong>
		  <code>URL: ${url}</code>
		  <code>Method: ${method}</code>
		  <code>Body: ${body}</code>
		  <code>Describe: ${describe}</code>
		  <code>Description: ${description}</code>
		  <code>Required: ${required}</code>
		  <code>Return: ${return}</code>
		</p>
	</div>
</template>
<template name="model">
	<div class="model ${selected}">
		<h4>${name}</h4>
		<h6>${type}</h6>
		<span>${description}</span>
		<blockquote class="code">
			<span class="code_blue">type</span> <span class="code_black">${name}</span> <span class="code_blue">struct</span> {<br/>
				${lines}
			}
		</blockquote>
	</div>
</template>
<template name="model_line">
	<div class="code_tab"><span class="code_black">${name}</span> ${type} <span class="code_orange">${tag}</span> <span class="code_gray">${comment}</span></div>
</template>

<template name="permissions">
	<table class="table table-responsive">
		<thead class="thead-dark">
			<tr><th>Permission</th><th>Name</th><th>Description</th></tr>
		</thead>
		<tbody id="permissions">

		</tbody>
	</table>
</template>
<template name="permissions_line">
	<tr class="${selected}">
		<td>${namespace}.${code_name}</td>
		<td>${title}</td>
		<td>${description}</td>
	</tr>
</template>

<template name="menus">
	<table class="table table-responsive">
		<thead class="thead-dark">
			<tr><th>Title</th><th>Permission</th><th>Icon</th><th>URL</th></tr>
		</thead>
		<tbody id="menus">

		</tbody>
	</table>
</template>
<template name="menus_line">
	<tr class="${selected}">
		<td>${title}</td><td>${permission}</td><td>${icon}</td><td>${url}</td>
	</tr>
</template>
<script>
	const urlParams = new URLSearchParams(window.location.search);
	var view = urlParams.get("view");
	var selectedApp;
	var ObjectMap = {};
	if (view == "") view = "app";

	$(document).ready(function() {

	    $.each(data, function(k, app) {
	        if (app.name == "") {
	            app.name = app.namespace
	        }
	        if (app.description == "") {
	            app.description = "No description"
	        }
	        var html = parseTpl($("template[name=menuitem]").html(), app);
	        $("#apps").append(html)

	        if (urlParams.get("app") == app.name) {
	            $("#apps li:last").addClass("active")
	            selectedApp = app
	        }
	        $.each(app.permissions,function(k,perm) {
	           ObjectMap[app.namespace+"."+perm.code_name] = "/bible?app="+app.namespace+"&view=permission&item="+perm.code_name
	        })
	        $.each(app.models,function(k,model) {
         	   ObjectMap[model.type] = "/bible?app="+app.namespace+"&view=model&item="+model.type
         	})
         	$.each(app.menus,function(k,menu) {
               ObjectMap[app.namespace+"."+menu.title] = "/bible?app="+app.namespace+"&view=menu&item="+menu.title
            })

            $.each(app.apis,function(k,api) {
                ObjectMap["api:"+app.namespace+"."+api.name] = "/bible?app="+app.namespace+"&view=api&item="+api.name
            })
            ObjectMap["app:"+app.namespace] = "/bible?app="+app
	        //
	    })

	    $("#apps>li.nav-item").click(function() {
	        window.location = $(this).find("a").attr("href")
	    })


	    if ($("#apps>li.nav-item.active").length == 0) {
	        $("#apps>li.nav-item:first").click()
	    }
        if(!selectedApp.models)
	        selectedApp.models = []
	    if(!selectedApp.apis)
        	selectedApp.apis = []
        if(!selectedApp.permissions)
        	selectedApp.permissions = []
        if(!selectedApp.menus)
        	selectedApp.menus = []

		if (view == "app") {
            var html = parseTpl($("template[name=app]").html(), {app:selectedApp.namespace});
            $("#content").html(html)
            $("#content #model_info").html(selectedApp.models.length+" model(s)")
            $("#content #api_info").html(selectedApp.apis.length+" api(s)")
            $("#content #permission_info").html(selectedApp.permissions.length+" permission(s)")
            $("#content #menu_info").html(selectedApp.menus.length+" menu(s)")
        }

		if(view == "api"){
			$.each(selectedApp.apis,function(k,api) {

			    if(!api.describe){
			        api.describe = []
			    }

			    api.describe = api.describe.join(", ")
			    var html = parseTpl($("template[name=api]").html(), api);
			    $("#content").append(html)
			})
		}

		if(view == "model"){
			$.each(selectedApp.models,function(k,model) {
				var lines = "";
				if(model.fields){
					for(var i = 0; i < model.fields.length; i++)
						lines += parseTpl($("template[name=model_line]").html(), parseStructLine(model.fields[i]));
				}
				model.selected = ( urlParams.get("item") == model.type )?"selected":""
				model.lines = lines
                var html = parseTpl($("template[name=model]").html(), model);
                $("#content").append(html)
            })
		}

		if(view == "permission"){
		    var lines = "";
            $.each(selectedApp.permissions,function(k,perm) {
                perm.namespace = selectedApp.namespace
                perm.selected = ( urlParams.get("item") == perm.code_name )?"selected":""
				lines += parseTpl($("template[name=permissions_line]").html(), perm);

            })
            var html = parseTpl($("template[name=permissions]").html(), {});

            $("#content").html(html)
            $("#permissions").html(lines)
        }

		if(view == "menu"){
            var lines = "";
            $.each(selectedApp.menus,function(k,menu) {
                menu.namespace = selectedApp.namespace
                menu.selected = ( urlParams.get("item") == menu.title )?"selected":""
                menu.url = '<a href="\\'+menu.url+'">'+menu.url+'</a>'
                menu.icon = menu.icon +" <i class='fa fa-"+menu.icon+"'></i>"
                if(menu.permission != "")
                    menu.permission = "#"+menu.permission
                lines += parseTpl($("template[name=menus_line]").html(), menu);

            })
            var html = parseTpl($("template[name=menus]").html(), {});

            $("#content").html(html)
            $("#menus").html(lines)
        }

	    $("#app_name").html(selectedApp.name)
	    var info = ""
	    if(selectedApp.description != ""){
	        info += selectedApp.description
	    }
	    if(selectedApp.author != ""){
        	info += ", author: "+selectedApp.author
        }
	    $("#app_info").html( info.trim() )

		if($("#content .selected").length > 0){
		    $("#content .selected").addClass("locked")
		    $([document.documentElement, document.body]).animate({
                    scrollTop: $("#content .selected").offset().top - 100
            }, 700);
		    setTimeout(function() {
		      $("#content .selected").removeClass("locked")
		    },700)
		}




	})

	function get(path, obj, fb = "") {
	    return path.split('.').reduce((res, key) => res[key] || fb, obj);
	}

	function parseTpl(template, map, fallback) {
	    return template.replace(/\$\{.+?}/g, (match) => {
	        const path = match.substr(2, match.length - 3).trim();
	        v = get(path, map, fallback);
	        // # parser
	        v = v.replace(/#\[{0,1}\]{0,1}\*{0,1}\w+(\.\w+)*/g,(hashtag)=>{
	            var hs = hashtag.substring(1)
	            if(hs[0] == "[")
	                hs = hs.substring(2)
	            console.warn(hs)
				if(ObjectMap.hasOwnProperty(hs)){
				    return "<a href='"+ObjectMap[hs]+"'>#"+hs+"</a>"
				}else{
				    return hs
				}

	        })
	         // end # parser

	        return v
	    });
	}

	function parseStructLine(line) {
	  var regex = /((\w+)\s+){1}(\[{0,1}\]{0,1}\*{0,1}\w+){1}\s*(`.+`){0,1}(\s*\/\/.+){0,1}/gm;
	  var res = {
	      name:"",
	      type:"",
	      tag:"",
	      comment:""
	  }
	  parsed = regex.exec(line.trim())
	  if(parsed){
	     res.name = parsed[2]
	     res.type = parsed[3]
	     if(parsed[4])
	        res.tag = parsed[4]
	     if(parsed[5])
	        res.comment = parsed[5]
	  }
	  return res
	}


</script>
